<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{fragments/layout}">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>图书列表 - 图书管理系统</title>
    <style>
        .search-form {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .action-buttons .btn {
            margin-right: 5px;
        }

        .table-hover tbody tr:hover {
            background-color: #f8f9fa;
        }

        .book-status {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
        }

        .status-available {
            background-color: #d1e7dd;
            color: #0f5132;
        }

        .status-unavailable {
            background-color: #f8d7da;
            color: #842029;
        }

        .pagination {
            justify-content: center;
        }

        .card {
            margin-bottom: 20px;
        }

        /* 屏幕阅读器专用 */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
    </style>
</head>

<body>
<div layout:fragment="content">
    <div class="container-fluid">
        <!-- 根据角色显示不同标题 -->
        <h1 class="mb-4" sec:authorize="hasRole('ADMIN')">图书管理</h1>
        <h1 class="mb-4" sec:authorize="hasRole('USER')">图书浏览</h1>

        <!-- 消息提示 -->
        <div th:if="${successMessage}" class="alert alert-success">
            <i class="fa fa-check-circle"></i> <span th:text="${successMessage}">操作成功！</span>
        </div>
        <div th:if="${errorMessage}" class="alert alert-danger">
            <i class="fa fa-exclamation-circle"></i> <span th:text="${errorMessage}">操作失败，请重试。</span>
        </div>

        <!-- 搜索表单 -->
        <div class="search-form">
            <form th:action="@{/books}" method="get">
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <label for="keyword" class="form-label">关键词</label>
                        <input type="text" id="keyword" name="keyword" class="form-control" th:value="${keyword}"
                               placeholder="书名、作者、ISBN等">
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="category" class="form-label">分类</label>
                        <select id="category" name="categoryId" class="form-control">
                            <option value="">全部分类</option>
                            <option th:each="category : ${categories}" th:value="${category.id}"
                                    th:text="${category.name}" th:selected="${categoryId == category.id}"></option>
                        </select>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="status" class="form-label">状态</label>
                        <select id="status" name="status" class="form-control">
                            <option value="">全部状态</option>
                            <option value="AVAILABLE" th:selected="${status == 'AVAILABLE'}">可借阅</option>
                            <option value="UNAVAILABLE" th:selected="${status == 'UNAVAILABLE'}">不可借阅</option>
                        </select>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label class="form-label">&nbsp;</label>
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary w-50">
                                <i class="fa fa-search"></i> 搜索
                            </button>
                            <a href="/books" class="btn btn-secondary w-50">
                                <i class="fa fa-refresh"></i> 重置
                            </a>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <!-- 操作栏 -->
        <div class="d-flex justify-content-between mb-3">
            <div>
                    <span class="text-muted">显示 <strong
                            th:text="${startIndex != null ? startIndex + 1 : 1}">1</strong>-<strong
                            th:text="${endIndex != null ? endIndex : 0}">10</strong> 条，共 <strong
                            th:text="${totalElements != null ? totalElements : 0}">100</strong> 条</span>
            </div>
            <!-- 仅管理员显示添加图书按钮 -->
            <div sec:authorize="hasRole('ADMIN')">
                <a th:href="@{/books/add}" class="btn btn-success">
                    <i class="fa fa-plus"></i> 添加图书
                </a>
            </div>
        </div>

        <!-- 图书列表 -->
        <div class="card">
            <div class="card-body">
                <table class="table table-hover">
                    <thead class="thead-light">
                    <tr>
                        <th>封面</th>
                        <th>书名</th>
                        <th>作者</th>
                        <th>ISBN</th>
                        <th>分类</th>
                        <th>价格</th>
                        <th>数量</th>
                        <th>状态</th>
                        <th>操作</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="book : ${books}">
                        <td>
                            <img th:src="@{|${book.coverImage}|}"
                                 onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCA2MCA4MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjYwIiBoZWlnaHQ9IjgwIiBmaWxsPSIjRjBGMEYwIi8+Cjx0ZXh0IHg9IjMwIiB5PSI0MCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1mYW1pbHk9IkFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjEyIiBmaWxsPSIjOTk5OTk5Ij5ObyBJbWFnZTwvdGV4dD4KPC9zdmc+'"
                                 width="60" height="80" class="rounded" alt="图书封面">
                        </td>
                        <td th:text="${book.title}">图书标题</td>
                        <td th:text="${book.author}">作者</td>
                        <td th:text="${book.isbn}">ISBN</td>
                        <td>
                                    <span th:each="cat, iter : ${book.categories}">
                                        <span th:text="${cat.name}">分类名</span>
                                        <span th:unless="${iter.last}">, </span>
                                    </span>
                        </td>
                        <td th:text="${'¥' + book.price}">价格</td>
                        <td th:text="${book.totalCopies}">数量</td>
                        <td>
                                    <span class="book-status"
                                          th:classappend="${book.availableCopies > 0 ? 'status-available' : 'status-unavailable'}">
                                        <i
                                                th:class="${book.availableCopies > 0 ? 'fa fa-check-circle' : 'fa fa-times-circle'}"></i>
                                        <span th:text="${book.availableCopies > 0 ? '可借阅' : '不可借阅'}"></span>
                                    </span>
                        </td>
                        <td class="action-buttons">
                            <!-- 管理员可见的编辑和删除按钮 -->
                            <div sec:authorize="hasRole('ADMIN')">
                                <a th:href="@{|/books/view/${book.id}|}" class="btn btn-sm btn-info" title="查看详情" aria-label="查看图书详情">
                                    <i class="fa fa-eye" aria-hidden="true"></i>
                                    <span class="sr-only">查看</span>
                                </a>
                                <a th:href="@{|/books/edit/${book.id}|}" class="btn btn-sm btn-primary" title="编辑图书" aria-label="编辑图书信息">
                                    <i class="fa fa-edit" aria-hidden="true"></i>
                                    <span class="sr-only">编辑</span>
                                </a>
                                <button th:attr="data-book-id=${book.id}" data-book-title="${book.title}"
                                        class="btn btn-sm btn-danger delete-btn" title="删除图书" aria-label="删除图书">
                                    <i class="fa fa-trash" aria-hidden="true"></i>
                                    <span class="sr-only">删除</span>
                                </button>
                            </div>
                            <!-- 普通用户可见的借阅按钮 -->
                            <div sec:authorize="hasRole('USER')" th:if="${book.availableCopies > 0}">
                                <a th:href="@{|/books/view/${book.id}|}" class="btn btn-sm btn-info" title="查看详情" aria-label="查看图书详情">
                                    <i class="fa fa-eye" aria-hidden="true"></i>
                                    <span class="sr-only">查看</span>
                                </a>
                                <a th:href="@{|/borrow/user/borrow?bookId=${book.id}|}"
                                   class="btn btn-sm btn-success" title="借阅图书" aria-label="借阅图书">
                                    <i class="fa fa-hand-lizard-o" aria-hidden="true"></i> 借阅
                                </a>
                            </div>
                            <!-- 普通用户可见但不可借阅的提示 -->
                            <div sec:authorize="hasRole('USER')" th:unless="${book.availableCopies > 0}">
                                <a th:href="@{|/books/view/${book.id}|}" class="btn btn-sm btn-info" title="查看详情" aria-label="查看图书详情">
                                    <i class="fa fa-eye" aria-hidden="true"></i>
                                    <span class="sr-only">查看</span>
                                </a>
                                <button class="btn btn-sm btn-secondary" disabled title="图书暂不可借" aria-label="图书暂不可借阅">
                                    <i class="fa fa-times" aria-hidden="true"></i> 不可借
                                </button>
                            </div>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 分页 -->
        <div class="mt-4" th:if="${totalPages > 1}">
            <nav aria-label="图书列表分页">
                <ul class="pagination">
                    <li class="page-item" th:classappend="${currentPage == 0 ? 'disabled':''}">
                        <a class="page-link"
                           th:href="@{|/books?page=${currentPage - 1}&keyword=${keyword}&categoryId=${categoryId}&status=${status}|}"
                           aria-label="上一页">
                            <span aria-hidden="true">&laquo;</span>
                        </a>
                    </li>
                    <li th:each="pageNum : ${pageNumbers}" class="page-item"
                        th:classappend="${pageNum == currentPage ? 'active':''}">
                        <a class="page-link"
                           th:href="@{|/books?page=${pageNum}&keyword=${keyword}&categoryId=${categoryId}&status=${status}|}"
                           th:text="${pageNum + 1}"
                           th:aria-label="'第' + ${pageNum + 1} + '页'">
                        </a>
                    </li>
                    <li class="page-item" th:classappend="${currentPage >= totalPages - 1 ? 'disabled':''}">
                        <a class="page-link"
                           th:href="@{|/books?page=${currentPage + 1}&keyword=${keyword}&categoryId=${categoryId}&status=${status}|}"
                           aria-label="下一页">
                            <span aria-hidden="true">&raquo;</span>
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>
</div>

<!-- 脚本放在页面底部确保DOM加载完成 -->
<script>
    console.log('脚本开始执行 - 当前时间:', new Date().toISOString());

        document.addEventListener('DOMContentLoaded', function() {
        console.log('DOMContentLoaded 事件触发');

        // 删除确认功能
        const deleteButtons = document.querySelectorAll('.delete-btn');
        console.log('找到删除按钮数量:', deleteButtons.length);

        deleteButtons.forEach(button => {
            button.addEventListener('click', function(e) {
                console.log('删除按钮被点击');
                e.preventDefault();
                e.stopPropagation();

                const bookId = this.getAttribute('data-book-id');
                const bookTitle = this.getAttribute('data-book-title') ||
                    this.closest('tr').querySelector('td:nth-child(2)').textContent;

                console.log('准备删除图书:', bookTitle, 'ID:', bookId);

                if (confirm(`确定要删除图书《${bookTitle}》吗？此操作不可撤销。`)) {
                    console.log('用户确认删除，跳转到:', '/books/delete/' + bookId);
                    // 添加加载状态
                    this.innerHTML = '<i class="fa fa-spinner fa-spin"></i> 删除中...';
                    this.disabled = true;

                    window.location.href = '/books/delete/' + bookId;
                } else {
                    console.log('用户取消删除');
                }
            });
        });

        console.log('删除按钮事件绑定完成');
    });

    // 备用的事件委托方式，防止动态内容问题
    document.addEventListener('click', function(e) {
        if (e.target.closest('.delete-btn')) {
            const button = e.target.closest('.delete-btn');
            const bookId = button.getAttribute('data-book-id');
            const bookTitle = button.getAttribute('data-book-title') ||
                button.closest('tr').querySelector('td:nth-child(2)').textContent;

            if (confirm(`确定要删除图书《${bookTitle}》吗？此操作不可撤销。`)) {
                button.innerHTML = '<i class="fa fa-spinner fa-spin"></i> 删除中...';
                button.disabled = true;
                window.location.href = '/books/delete/' + bookId;
            }
            e.preventDefault();
        }
    });

    // 图片错误处理
    document.addEventListener('error', function(e) {
        if (e.target.tagName === 'IMG') {
            e.target.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCA2MCA4MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjYwIiBoZWlnaHQ9IjgwIiBmaWxsPSIjRjBGMEYwIi8+Cjx0ZXh0IHg9IjMwIiB5PSI0MCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1mYW1pbHk9IkFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjEyIiBmaWxsPSIjOTk5OTk5Ij5ObyBJbWFnZTwvdGV4dD4KPC9zdmc+';
        }
    }, true);
</script>
</body>
</html>